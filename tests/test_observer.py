
import numpy as np

from admiral.component_envs.world import GridWorldEnv
from admiral.component_envs.movement import GridMovementEnv, GridMovementAgent
from admiral.component_envs.observer import GridObserver, ObservingTeamAgent

class ObservingTeamMovementAgent(ObservingTeamAgent, GridMovementAgent):
    pass
class SimpleGridObservations:
    def __init__(self, **kwargs):
        self.agents = kwargs['agents']
        self.world = GridWorldEnv(**kwargs)
        self.movement = GridMovementEnv(**kwargs)
        self.observer = GridObserver(**kwargs)

    def reset(self, **kwargs):
        self.world.reset(**kwargs)

        return {agent_id: self.observer.get_obs(agent_id) for agent_id in self.agents}
    
    def step(self, action_dict, **kwargs):
        for agent_id, action in action_dict.items():
            agent = self.agents[agent_id]
            if 'move' in action:
                agent.position = self.movement.process_move(agent.position, action['move'])

        return {agent_id: self.observer.get_obs(agent_id) for agent_id in self.agents}

team_shapes = {
    1: 'o',
    2: 's',
    3: 'd'
}

def test_grid_observer_multiple_teams_with_movement():
    agents = {
        'agent0': ObservingTeamMovementAgent(id='agent0', team=1, view=1, move=1, starting_position=np.array([2, 1])),
        'agent1': ObservingTeamMovementAgent(id='agent1', team=2, view=4, move=0, starting_position=np.array([0, 4])),
        'agent2': ObservingTeamMovementAgent(id='agent2', team=2, view=4, move=0, starting_position=np.array([0, 0])),
        'agent3': ObservingTeamMovementAgent(id='agent3', team=3, view=4, move=0, starting_position=np.array([4, 0])),
        'agent4': ObservingTeamMovementAgent(id='agent4', team=3, view=4, move=0, starting_position=np.array([4, 4])),
        'agent5': ObservingTeamMovementAgent(id='agent5', team=1, view=2, move=0, starting_position=np.array([2, 2])),
        'agent6': ObservingTeamMovementAgent(id='agent6', team=1, view=1, move=0, starting_position=np.array([0, 4])),
        'agent7': ObservingTeamMovementAgent(id='agent7', team=1, view=1, move=0, starting_position=np.array([0, 0])),
        'agent8': ObservingTeamMovementAgent(id='agent8', team=1, view=1, move=0, starting_position=np.array([4, 0])),
        'agent9': ObservingTeamMovementAgent(id='agent9', team=1, view=1, move=0, starting_position=np.array([4, 4])),
    }
    env = SimpleGridObservations(
        region=5,
        agents=agents
    )
    obs = env.reset()
    np.testing.assert_array_equal(obs['agent0'], np.array([
        [0., 0., 0.],
        [0., 0., 1.],
        [0., 0., 0.],
    ]))
    np.testing.assert_array_equal(obs['agent5'], np.array([
        [2., 0., 0., 0., 2.],
        [0., 0., 0., 0., 0.],
        [0., 1., 0., 0., 0.],
        [0., 0., 0., 0., 0.],
        [3., 0., 0., 0., 3.]]))
    np.testing.assert_array_equal(obs['agent1'], np.array([
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [ 2.,  0.,  0.,  0.,  1., -1., -1., -1., -1.],
        [ 0.,  0.,  0.,  0.,  0., -1., -1., -1., -1.],
        [ 0.,  1.,  1.,  0.,  0., -1., -1., -1., -1.],
        [ 0.,  0.,  0.,  0.,  0., -1., -1., -1., -1.],
        [ 3.,  0.,  0.,  0.,  3., -1., -1., -1., -1.]]))
    np.testing.assert_array_equal(obs['agent2'], np.array([
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1.,  1.,  0.,  0.,  0.,  2.],
        [-1., -1., -1., -1.,  0.,  0.,  0.,  0.,  0.],
        [-1., -1., -1., -1.,  0.,  1.,  1.,  0.,  0.],
        [-1., -1., -1., -1.,  0.,  0.,  0.,  0.,  0.],
        [-1., -1., -1., -1.,  3.,  0.,  0.,  0.,  3.]]))
    np.testing.assert_array_equal(obs['agent3'], np.array([
        [-1., -1., -1., -1.,  2.,  0.,  0.,  0.,  2.],
        [-1., -1., -1., -1.,  0.,  0.,  0.,  0.,  0.],
        [-1., -1., -1., -1.,  0.,  1.,  1.,  0.,  0.],
        [-1., -1., -1., -1.,  0.,  0.,  0.,  0.,  0.],
        [-1., -1., -1., -1.,  1.,  0.,  0.,  0.,  3.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.]]))
    np.testing.assert_array_equal(obs['agent4'], np.array([
        [ 2.,  0.,  0.,  0.,  2., -1., -1., -1., -1.],
        [ 0.,  0.,  0.,  0.,  0., -1., -1., -1., -1.],
        [ 0.,  1.,  1.,  0.,  0., -1., -1., -1., -1.],
        [ 0.,  0.,  0.,  0.,  0., -1., -1., -1., -1.],
        [ 3.,  0.,  0.,  0.,  1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.]]))

    obs = env.step({'agent0': {'move': np.array([-1, 0])}})
    np.testing.assert_array_equal(obs['agent0'], np.array([
        [2., 0., 0.],
        [0., 0., 0.],
        [0., 0., 1.],
    ]))
    np.testing.assert_array_equal(obs['agent5'], np.array([
        [2., 0., 0., 0., 2.],
        [0., 1., 0., 0., 0.],
        [0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0.],
        [3., 0., 0., 0., 3.]]))
    np.testing.assert_array_equal(obs['agent1'], np.array([
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [ 2.,  0.,  0.,  0.,  1., -1., -1., -1., -1.],
        [ 0.,  1.,  0.,  0.,  0., -1., -1., -1., -1.],
        [ 0.,  0.,  1.,  0.,  0., -1., -1., -1., -1.],
        [ 0.,  0.,  0.,  0.,  0., -1., -1., -1., -1.],
        [ 3.,  0.,  0.,  0.,  3., -1., -1., -1., -1.]]))
    np.testing.assert_array_equal(obs['agent2'], np.array([
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1.,  1.,  0.,  0.,  0.,  2.],
        [-1., -1., -1., -1.,  0.,  1.,  0.,  0.,  0.],
        [-1., -1., -1., -1.,  0.,  0.,  1.,  0.,  0.],
        [-1., -1., -1., -1.,  0.,  0.,  0.,  0.,  0.],
        [-1., -1., -1., -1.,  3.,  0.,  0.,  0.,  3.]]))
    np.testing.assert_array_equal(obs['agent3'], np.array([
        [-1., -1., -1., -1.,  2.,  0.,  0.,  0.,  2.],
        [-1., -1., -1., -1.,  0.,  1.,  0.,  0.,  0.],
        [-1., -1., -1., -1.,  0.,  0.,  1.,  0.,  0.],
        [-1., -1., -1., -1.,  0.,  0.,  0.,  0.,  0.],
        [-1., -1., -1., -1.,  1.,  0.,  0.,  0.,  3.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.]]))
    np.testing.assert_array_equal(obs['agent4'], np.array([
        [ 2.,  0.,  0.,  0.,  2., -1., -1., -1., -1.],
        [ 0.,  1.,  0.,  0.,  0., -1., -1., -1., -1.],
        [ 0.,  0.,  1.,  0.,  0., -1., -1., -1., -1.],
        [ 0.,  0.,  0.,  0.,  0., -1., -1., -1., -1.],
        [ 3.,  0.,  0.,  0.,  1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.]]))

    obs = env.step({'agent0': {'move': np.array([0, 1])}})
    np.testing.assert_array_equal(obs['agent0'], np.array([
        [0., 0., 0.],
        [0., 0., 0.],
        [0., 1., 0.],
    ]))
    np.testing.assert_array_equal(obs['agent5'], np.array([
        [2., 0., 0., 0., 2.],
        [0., 0., 1., 0., 0.],
        [0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0.],
        [3., 0., 0., 0., 3.]]))
    np.testing.assert_array_equal(obs['agent1'], np.array([
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [ 2.,  0.,  0.,  0.,  1., -1., -1., -1., -1.],
        [ 0.,  0.,  1.,  0.,  0., -1., -1., -1., -1.],
        [ 0.,  0.,  1.,  0.,  0., -1., -1., -1., -1.],
        [ 0.,  0.,  0.,  0.,  0., -1., -1., -1., -1.],
        [ 3.,  0.,  0.,  0.,  3., -1., -1., -1., -1.]]))
    np.testing.assert_array_equal(obs['agent2'], np.array([
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1.,  1.,  0.,  0.,  0.,  2.],
        [-1., -1., -1., -1.,  0.,  0.,  1.,  0.,  0.],
        [-1., -1., -1., -1.,  0.,  0.,  1.,  0.,  0.],
        [-1., -1., -1., -1.,  0.,  0.,  0.,  0.,  0.],
        [-1., -1., -1., -1.,  3.,  0.,  0.,  0.,  3.]]))
    np.testing.assert_array_equal(obs['agent3'], np.array([
        [-1., -1., -1., -1.,  2.,  0.,  0.,  0.,  2.],
        [-1., -1., -1., -1.,  0.,  0.,  1.,  0.,  0.],
        [-1., -1., -1., -1.,  0.,  0.,  1.,  0.,  0.],
        [-1., -1., -1., -1.,  0.,  0.,  0.,  0.,  0.],
        [-1., -1., -1., -1.,  1.,  0.,  0.,  0.,  3.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.]]))
    np.testing.assert_array_equal(obs['agent4'], np.array([
        [ 2.,  0.,  0.,  0.,  2., -1., -1., -1., -1.],
        [ 0.,  0.,  1.,  0.,  0., -1., -1., -1., -1.],
        [ 0.,  0.,  1.,  0.,  0., -1., -1., -1., -1.],
        [ 0.,  0.,  0.,  0.,  0., -1., -1., -1., -1.],
        [ 3.,  0.,  0.,  0.,  1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.]]))

    obs = env.step({'agent0': {'move': np.array([0, 1])}})
    np.testing.assert_array_equal(obs['agent0'], np.array([
        [0., 0., 2.],
        [0., 0., 0.],
        [1., 0., 0.],
    ]))
    np.testing.assert_array_equal(obs['agent5'], np.array([
        [2., 0., 0., 0., 2.],
        [0., 0., 0., 1., 0.],
        [0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0.],
        [3., 0., 0., 0., 3.]]))
    np.testing.assert_array_equal(obs['agent1'], np.array([
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [ 2.,  0.,  0.,  0.,  1., -1., -1., -1., -1.],
        [ 0.,  0.,  0.,  1.,  0., -1., -1., -1., -1.],
        [ 0.,  0.,  1.,  0.,  0., -1., -1., -1., -1.],
        [ 0.,  0.,  0.,  0.,  0., -1., -1., -1., -1.],
        [ 3.,  0.,  0.,  0.,  3., -1., -1., -1., -1.]]))
    np.testing.assert_array_equal(obs['agent2'], np.array([
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1.,  1.,  0.,  0.,  0.,  2.],
        [-1., -1., -1., -1.,  0.,  0.,  0.,  1.,  0.],
        [-1., -1., -1., -1.,  0.,  0.,  1.,  0.,  0.],
        [-1., -1., -1., -1.,  0.,  0.,  0.,  0.,  0.],
        [-1., -1., -1., -1.,  3.,  0.,  0.,  0.,  3.]]))
    np.testing.assert_array_equal(obs['agent3'], np.array([
        [-1., -1., -1., -1.,  2.,  0.,  0.,  0.,  2.],
        [-1., -1., -1., -1.,  0.,  0.,  0.,  1.,  0.],
        [-1., -1., -1., -1.,  0.,  0.,  1.,  0.,  0.],
        [-1., -1., -1., -1.,  0.,  0.,  0.,  0.,  0.],
        [-1., -1., -1., -1.,  1.,  0.,  0.,  0.,  3.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.]]))
    np.testing.assert_array_equal(obs['agent4'], np.array([
        [ 2.,  0.,  0.,  0.,  2., -1., -1., -1., -1.],
        [ 0.,  0.,  0.,  1.,  0., -1., -1., -1., -1.],
        [ 0.,  0.,  1.,  0.,  0., -1., -1., -1., -1.],
        [ 0.,  0.,  0.,  0.,  0., -1., -1., -1., -1.],
        [ 3.,  0.,  0.,  0.,  1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.]]))

    obs = env.step({'agent0': {'move': np.array([1, 0])}})
    np.testing.assert_array_equal(obs['agent0'], np.array([
        [0., 0., 0.],
        [1., 0., 0.],
        [0., 0., 0.],
    ]))
    np.testing.assert_array_equal(obs['agent5'], np.array([
        [2., 0., 0., 0., 2.],
        [0., 0., 0., 0., 0.],
        [0., 0., 0., 1., 0.],
        [0., 0., 0., 0., 0.],
        [3., 0., 0., 0., 3.]]))
    np.testing.assert_array_equal(obs['agent1'], np.array([
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [ 2.,  0.,  0.,  0.,  1., -1., -1., -1., -1.],
        [ 0.,  0.,  0.,  0.,  0., -1., -1., -1., -1.],
        [ 0.,  0.,  1.,  1.,  0., -1., -1., -1., -1.],
        [ 0.,  0.,  0.,  0.,  0., -1., -1., -1., -1.],
        [ 3.,  0.,  0.,  0.,  3., -1., -1., -1., -1.]]))
    np.testing.assert_array_equal(obs['agent2'], np.array([
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1.,  1.,  0.,  0.,  0.,  2.],
        [-1., -1., -1., -1.,  0.,  0.,  0.,  0.,  0.],
        [-1., -1., -1., -1.,  0.,  0.,  1.,  1.,  0.],
        [-1., -1., -1., -1.,  0.,  0.,  0.,  0.,  0.],
        [-1., -1., -1., -1.,  3.,  0.,  0.,  0.,  3.]]))
    np.testing.assert_array_equal(obs['agent3'], np.array([
        [-1., -1., -1., -1.,  2.,  0.,  0.,  0.,  2.],
        [-1., -1., -1., -1.,  0.,  0.,  0.,  0.,  0.],
        [-1., -1., -1., -1.,  0.,  0.,  1.,  1.,  0.],
        [-1., -1., -1., -1.,  0.,  0.,  0.,  0.,  0.],
        [-1., -1., -1., -1.,  1.,  0.,  0.,  0.,  3.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.]]))
    np.testing.assert_array_equal(obs['agent4'], np.array([
        [ 2.,  0.,  0.,  0.,  2., -1., -1., -1., -1.],
        [ 0.,  0.,  0.,  0.,  0., -1., -1., -1., -1.],
        [ 0.,  0.,  1.,  1.,  0., -1., -1., -1., -1.],
        [ 0.,  0.,  0.,  0.,  0., -1., -1., -1., -1.],
        [ 3.,  0.,  0.,  0.,  1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.]]))

    obs = env.step({'agent0': {'move': np.array([1, 0])}})
    np.testing.assert_array_equal(obs['agent0'], np.array([
        [1., 0., 0.],
        [0., 0., 0.],
        [0., 0., 3.],
    ]))
    np.testing.assert_array_equal(obs['agent5'], np.array([
        [2., 0., 0., 0., 2.],
        [0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0.],
        [0., 0., 0., 1., 0.],
        [3., 0., 0., 0., 3.]]))
    np.testing.assert_array_equal(obs['agent1'], np.array([
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [ 2.,  0.,  0.,  0.,  1., -1., -1., -1., -1.],
        [ 0.,  0.,  0.,  0.,  0., -1., -1., -1., -1.],
        [ 0.,  0.,  1.,  0.,  0., -1., -1., -1., -1.],
        [ 0.,  0.,  0.,  1.,  0., -1., -1., -1., -1.],
        [ 3.,  0.,  0.,  0.,  3., -1., -1., -1., -1.]]))
    np.testing.assert_array_equal(obs['agent2'], np.array([
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1.,  1.,  0.,  0.,  0.,  2.],
        [-1., -1., -1., -1.,  0.,  0.,  0.,  0.,  0.],
        [-1., -1., -1., -1.,  0.,  0.,  1.,  0.,  0.],
        [-1., -1., -1., -1.,  0.,  0.,  0.,  1.,  0.],
        [-1., -1., -1., -1.,  3.,  0.,  0.,  0.,  3.]]))
    np.testing.assert_array_equal(obs['agent3'], np.array([
        [-1., -1., -1., -1.,  2.,  0.,  0.,  0.,  2.],
        [-1., -1., -1., -1.,  0.,  0.,  0.,  0.,  0.],
        [-1., -1., -1., -1.,  0.,  0.,  1.,  0.,  0.],
        [-1., -1., -1., -1.,  0.,  0.,  0.,  1.,  0.],
        [-1., -1., -1., -1.,  1.,  0.,  0.,  0.,  3.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.]]))
    np.testing.assert_array_equal(obs['agent4'], np.array([
        [ 2.,  0.,  0.,  0.,  2., -1., -1., -1., -1.],
        [ 0.,  0.,  0.,  0.,  0., -1., -1., -1., -1.],
        [ 0.,  0.,  1.,  0.,  0., -1., -1., -1., -1.],
        [ 0.,  0.,  0.,  1.,  0., -1., -1., -1., -1.],
        [ 3.,  0.,  0.,  0.,  1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.]]))

    obs = env.step({'agent0': {'move': np.array([0, -1])}})
    np.testing.assert_array_equal(obs['agent0'], np.array([
        [0., 1., 0.],
        [0., 0., 0.],
        [0., 0., 0.],
    ]))
    np.testing.assert_array_equal(obs['agent5'], np.array([
        [2., 0., 0., 0., 2.],
        [0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0.],
        [0., 0., 1., 0., 0.],
        [3., 0., 0., 0., 3.]]))
    np.testing.assert_array_equal(obs['agent1'], np.array([
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [ 2.,  0.,  0.,  0.,  1., -1., -1., -1., -1.],
        [ 0.,  0.,  0.,  0.,  0., -1., -1., -1., -1.],
        [ 0.,  0.,  1.,  0.,  0., -1., -1., -1., -1.],
        [ 0.,  0.,  1.,  0.,  0., -1., -1., -1., -1.],
        [ 3.,  0.,  0.,  0.,  3., -1., -1., -1., -1.]]))
    np.testing.assert_array_equal(obs['agent2'], np.array([
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1.,  1.,  0.,  0.,  0.,  2.],
        [-1., -1., -1., -1.,  0.,  0.,  0.,  0.,  0.],
        [-1., -1., -1., -1.,  0.,  0.,  1.,  0.,  0.],
        [-1., -1., -1., -1.,  0.,  0.,  1.,  0.,  0.],
        [-1., -1., -1., -1.,  3.,  0.,  0.,  0.,  3.]]))
    np.testing.assert_array_equal(obs['agent3'], np.array([
        [-1., -1., -1., -1.,  2.,  0.,  0.,  0.,  2.],
        [-1., -1., -1., -1.,  0.,  0.,  0.,  0.,  0.],
        [-1., -1., -1., -1.,  0.,  0.,  1.,  0.,  0.],
        [-1., -1., -1., -1.,  0.,  0.,  1.,  0.,  0.],
        [-1., -1., -1., -1.,  1.,  0.,  0.,  0.,  3.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.]]))
    np.testing.assert_array_equal(obs['agent4'], np.array([
        [ 2.,  0.,  0.,  0.,  2., -1., -1., -1., -1.],
        [ 0.,  0.,  0.,  0.,  0., -1., -1., -1., -1.],
        [ 0.,  0.,  1.,  0.,  0., -1., -1., -1., -1.],
        [ 0.,  0.,  1.,  0.,  0., -1., -1., -1., -1.],
        [ 3.,  0.,  0.,  0.,  1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.]]))

    obs = env.step({'agent0': {'move': np.array([0, -1])}})
    np.testing.assert_array_equal(obs['agent0'], np.array([
        [0., 0., 1.],
        [0., 0., 0.],
        [3., 0., 0.],
    ]))
    np.testing.assert_array_equal(obs['agent5'], np.array([
        [2., 0., 0., 0., 2.],
        [0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0.],
        [0., 1., 0., 0., 0.],
        [3., 0., 0., 0., 3.]]))
    np.testing.assert_array_equal(obs['agent1'], np.array([
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [ 2.,  0.,  0.,  0.,  1., -1., -1., -1., -1.],
        [ 0.,  0.,  0.,  0.,  0., -1., -1., -1., -1.],
        [ 0.,  0.,  1.,  0.,  0., -1., -1., -1., -1.],
        [ 0.,  1.,  0.,  0.,  0., -1., -1., -1., -1.],
        [ 3.,  0.,  0.,  0.,  3., -1., -1., -1., -1.]]))
    np.testing.assert_array_equal(obs['agent2'], np.array([
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1.,  1.,  0.,  0.,  0.,  2.],
        [-1., -1., -1., -1.,  0.,  0.,  0.,  0.,  0.],
        [-1., -1., -1., -1.,  0.,  0.,  1.,  0.,  0.],
        [-1., -1., -1., -1.,  0.,  1.,  0.,  0.,  0.],
        [-1., -1., -1., -1.,  3.,  0.,  0.,  0.,  3.]]))
    np.testing.assert_array_equal(obs['agent3'], np.array([
        [-1., -1., -1., -1.,  2.,  0.,  0.,  0.,  2.],
        [-1., -1., -1., -1.,  0.,  0.,  0.,  0.,  0.],
        [-1., -1., -1., -1.,  0.,  0.,  1.,  0.,  0.],
        [-1., -1., -1., -1.,  0.,  1.,  0.,  0.,  0.],
        [-1., -1., -1., -1.,  1.,  0.,  0.,  0.,  3.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.]]))
    np.testing.assert_array_equal(obs['agent4'], np.array([
        [ 2.,  0.,  0.,  0.,  2., -1., -1., -1., -1.],
        [ 0.,  0.,  0.,  0.,  0., -1., -1., -1., -1.],
        [ 0.,  0.,  1.,  0.,  0., -1., -1., -1., -1.],
        [ 0.,  1.,  0.,  0.,  0., -1., -1., -1., -1.],
        [ 3.,  0.,  0.,  0.,  1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.]]))

    obs = env.step({'agent0': {'move': np.array([-1, 0])}})
    np.testing.assert_array_equal(obs['agent0'], np.array([
        [0., 0., 0.],
        [0., 0., 1.],
        [0., 0., 0.],
    ]))
    np.testing.assert_array_equal(obs['agent5'], np.array([
        [2., 0., 0., 0., 2.],
        [0., 0., 0., 0., 0.],
        [0., 1., 0., 0., 0.],
        [0., 0., 0., 0., 0.],
        [3., 0., 0., 0., 3.]]))
    np.testing.assert_array_equal(obs['agent1'], np.array([
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [ 2.,  0.,  0.,  0.,  1., -1., -1., -1., -1.],
        [ 0.,  0.,  0.,  0.,  0., -1., -1., -1., -1.],
        [ 0.,  1.,  1.,  0.,  0., -1., -1., -1., -1.],
        [ 0.,  0.,  0.,  0.,  0., -1., -1., -1., -1.],
        [ 3.,  0.,  0.,  0.,  3., -1., -1., -1., -1.]]))
    np.testing.assert_array_equal(obs['agent2'], np.array([
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1.,  1.,  0.,  0.,  0.,  2.],
        [-1., -1., -1., -1.,  0.,  0.,  0.,  0.,  0.],
        [-1., -1., -1., -1.,  0.,  1.,  1.,  0.,  0.],
        [-1., -1., -1., -1.,  0.,  0.,  0.,  0.,  0.],
        [-1., -1., -1., -1.,  3.,  0.,  0.,  0.,  3.]]))
    np.testing.assert_array_equal(obs['agent3'], np.array([
        [-1., -1., -1., -1.,  2.,  0.,  0.,  0.,  2.],
        [-1., -1., -1., -1.,  0.,  0.,  0.,  0.,  0.],
        [-1., -1., -1., -1.,  0.,  1.,  1.,  0.,  0.],
        [-1., -1., -1., -1.,  0.,  0.,  0.,  0.,  0.],
        [-1., -1., -1., -1.,  1.,  0.,  0.,  0.,  3.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.]]))
    np.testing.assert_array_equal(obs['agent4'], np.array([
        [ 2.,  0.,  0.,  0.,  2., -1., -1., -1., -1.],
        [ 0.,  0.,  0.,  0.,  0., -1., -1., -1., -1.],
        [ 0.,  1.,  1.,  0.,  0., -1., -1., -1., -1.],
        [ 0.,  0.,  0.,  0.,  0., -1., -1., -1., -1.],
        [ 3.,  0.,  0.,  0.,  1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.],
        [-1., -1., -1., -1., -1., -1., -1., -1., -1.]]))
